!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("cyberuskey-sdk",[],t):"object"==typeof exports?exports["cyberuskey-sdk"]=t():e["cyberuskey-sdk"]=t()}(window,function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=4)}([function(e,t,n){"use strict";var r;Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e[void 0]=1]="undefined",e[e.unknown_error=2]="unknown_error",e[e.server_error=3]="server_error",e[e.wrong_json=4]="wrong_json",e[e.openapi_error=5]="openapi_error",e[e.resource_not_found=6]="resource_not_found",e[e.otp_generation_failure=7]="otp_generation_failure",e[e.invalid_redirect_uri=8]="invalid_redirect_uri",e[e.invalid_client=9]="invalid_client",e[e.too_many_calls_error=10]="too_many_calls_error"}(r||(r={})),t.ErrorCode=r;class o extends Error{constructor(e,t){super(t),this._code=r[e]}get code(){return r[this._code]}get description(){return this.message}}t.CyberusKeyError=o;class i extends o{constructor(e="unknown_error",t="Unknown error occured."){super(e,t)}}t.UnknownError=i;class s extends o{constructor(e="too_many_calls_error",t="You've done too many calls."){super(e,t)}}t.TooManyCallsError=s;t.MissingRedirectUri=class extends o{constructor(){super("invalid_redirect_uri","Missing redirection URI.")}};class c extends o{}t.WrongJsonError=c;class u extends o{}t.OpenApiError=u;class a extends o{}t.ResourceNotFoundError=a;class d extends o{}t.OTPGenerationError=d;const l={[r.undefined]:i,[r.unknown_error]:i,[r.server_error]:i,[r.undefined]:c,[r.wrong_json]:c,[r.openapi_error]:u,[r.resource_not_found]:a,[r.otp_generation_failure]:d,[r.invalid_redirect_uri]:class extends o{},[r.invalid_client]:class extends o{},[r.too_many_calls_error]:s};t.errorFactory=function(e,t){const n=r[e];return new(0,l[n])(e,t)}},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function c(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(s,c)}u((r=r.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const o=n(0),i=n(2);t.CyberusKeyAPI=class{constructor(e,t,n=600){this._apiUrl=new URL("/api/v2/",e),this._geoProvider=t,this._delayMs=n}createSession(e,t){return r(this,void 0,void 0,function*(){const n={client_id:e};t&&(n.lat=t.latitude,n.lng=t.longitude);const r=yield fetch(this._getUrl("sessions"),{method:"POST",body:this._getUrlEncodedBody(n),headers:{"Content-Type":"application/x-www-form-urlencoded"}}),s=yield r.json();if(r.ok&&201===r.status&&s.success)return new i.Session(s.data);if(!s.error)throw new o.UnknownError;throw o.errorFactory(s.error,s.error_description)})}getOTPSound(e){return r(this,void 0,void 0,function*(){const t=yield fetch(this._getUrl(`sessions/${e.sessionId}`),{headers:{Accept:"audio/mpeg","Content-Type":"text/plain"}}),n=t.buffer||t.arrayBuffer;return yield n.call(t)})}getAuthenticationEndpointUrl(e,t,n,r,o,i){const s={session_id:e.sessionId,client_id:n,scope:t.getValue(),redirect_uri:r,response_type:"code"};o&&(s.state=o),i&&(s.nonce=i);const c=new URL(this._getUrl("authenticate"));return Object.keys(s).forEach(e=>{c.searchParams.append(e,s[e])}),c.href}authenticate(e,t,n,o,i,s,c){return r(this,void 0,void 0,function*(){this._geoProvider&&!this._cachedGeo&&(this._cachedGeo=yield this._geoProvider.getGeo());const r=yield this.createSession(e,this._cachedGeo),u=yield this.getOTPSound(r),a=this.getAuthenticationEndpointUrl(r,n,e,t,s,c);console.info(`Navigating to ${a}.`),yield i.navigate(a),yield this._timeout(1e3),console.info("Sound emitting."),yield o.emit(u)})}navigateAndGetTheSound(e,t,n,o,i,s){return r(this,void 0,void 0,function*(){this._geoProvider&&!this._cachedGeo&&(this._cachedGeo=yield this._geoProvider.getGeo());const r=yield this.createSession(e,this._cachedGeo),c=yield this.getOTPSound(r),u=this.getAuthenticationEndpointUrl(r,n,e,t,i,s);return console.info(`Navigating to ${u}.`),yield o.navigate(u),yield this._timeout(this._delayMs),c})}_getUrl(e){return new URL(e,this._apiUrl).href}_getUrlEncodedBody(e){return Object.keys(e).reduce((t,n)=>{const r=encodeURIComponent(n),o=encodeURIComponent(e[n]);return t.push(`${r}=${o}`),t},[]).join("&")}_timeout(e){return new Promise(t=>setTimeout(t,e))}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.Session=class{constructor(e){this.sessionId=e.session_id,this.createdAt=new Date(e.created_at)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.Geolocation=class{constructor(e,t,n){this._latitude=e,this._longitude=t,this._accuracy=n}get latitude(){return this._latitude}get longitude(){return this._longitude}get accuracy(){return this._accuracy}}},function(e,t,n){"use strict";function r(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}Object.defineProperty(t,"__esModule",{value:!0}),r(n(1)),r(n(5)),r(n(0)),r(n(6)),r(n(7)),r(n(2)),r(n(3)),r(n(8));const o=n(1);t.default=o.CyberusKeyAPI},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function c(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(s,c)}u((r=r.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});t.WebAudioSoundEmitter=class{emit(e){return r(this,void 0,void 0,function*(){let t;try{t=new AudioContext}catch(e){throw console.error("AudioContext is not supported."),e}const n=yield t.decodeAudioData(e),r=t.createBufferSource();r.buffer=n,r.connect(t.destination),yield new Promise(e=>{r.onended=e,r.start(0)})})}}},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function c(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(s,c)}u((r=r.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const o=n(0);t.RedirectNavigator=class{navigate(e){return r(this,void 0,void 0,function*(){if(!e)throw new o.MissingRedirectUri;return window.location.href=e,Promise.resolve()})}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.OpenIdScopeParser=class{constructor(){this._scope=["openid"]}addEmail(){return this._scope.includes("email")?this:(this._scope.push("email"),this)}addProfile(){return this._scope.includes("profile")?this:(this._scope.push("profile"),this)}getValue(){return this._scope.join(" ")}}},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function c(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(s,c)}u((r=r.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const o=n(3);t.HTML5GeoProvider=class{constructor(e=window.navigator){this._navigator=e}getGeo(){return r(this,void 0,void 0,function*(){let e=null;try{e=yield this._getGeo()}catch(e){return null}const{coords:t}=e;return new o.Geolocation(t.latitude,t.longitude,t.accuracy)})}_getGeo(){return new Promise((e,t)=>{this._navigator.geolocation.getCurrentPosition(e,t,{enableHighAccuracy:!0})})}}}])});